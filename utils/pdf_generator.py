from fpdf import FPDF
import os
import qrcode

class PDF(FPDF):
    def header(self):
        if os.path.exists("static/logo.png"):
            self.image("static/logo.png", 10, 8, 30)
        self.set_font("Helvetica", "B", 16)
        self.cell(0, 10, "Navadharma Prediction Report", ln=True, align="C")
        self.ln(10)

    def footer(self):
        self.set_y(-20)
        self.set_font("Helvetica", "I", 10)
        self.cell(0, 10, "— Nav, Principal Astrologer", ln=True, align="C")
        self.cell(0, 10, "Generated by Navadharma.com", align="C")

def generate_pdf(data: dict, filename="report.pdf"):
    pdf = PDF()
    pdf.add_page()
    pdf.set_auto_page_break(auto=True, margin=15)
    pdf.set_font("Helvetica", "", 12)

    def section_title(title):
        pdf.set_font("Helvetica", "B", 13)
        pdf.set_text_color(0)
        pdf.cell(0, 10, title, ln=True)
        pdf.set_font("Helvetica", "", 12)
        pdf.set_text_color(30, 30, 30)

    # 🌞 Birth Details
    section_title("Birth Details")
    pdf.cell(0, 10, f"Date: {data.get('date', '—')}", ln=True)
    pdf.cell(0, 10, f"Time: {data.get('time', '—')}", ln=True)
    pdf.cell(0, 10, f"Place: {data.get('place', '—')}", ln=True)
    pdf.ln(4)

    # 📊 Lagna & Dasha
    section_title("Current Astrological Snapshot")
    dasha = data.get("currentDasha", {})
    pdf.cell(0, 10, f"Lagna: {data.get('lagna', '—')}", ln=True)
    pdf.cell(0, 10, f"Mahadasha: {dasha.get('mahadasha')} | Antardasha: {dasha.get('antardasha')}", ln=True)
    pdf.cell(0, 10, f"Period: {dasha.get('period')}", ln=True)
    pdf.ln(4)

    # ✨ Nakshatra
    section_title("Nakshatra & Yogas")
    nak = data.get("nakshatra", {})
    pdf.cell(0, 10, f"Nakshatra: {nak.get('nakshatra')} (Lord: {nak.get('nakshatra_lord')})", ln=True)
    yogas = nak.get("yogas", [])
    for y in yogas:
        pdf.multi_cell(0, 8, f"🪐 {y['name']}: {y['effect']}")
    pdf.ln(4)

    # 🧾 Remedies
    section_title("Recommended Remedies")
    for rem in data.get("remedies", []):
        pdf.multi_cell(0, 8, f"🔸 {rem}")
    pdf.ln(4)

    # 📈 Divisional Charts
    section_title("Divisional Charts")
    divs = data.get("divisional_charts", {})
    for key, val in divs.items():
        pdf.multi_cell(0, 8, f"{key} (Asc: {val.get('ascendant')}) - {val.get('notes')}")
    pdf.ln(4)

    # 🤖 GPT Summary
    section_title("Astrologer's Insight")
    summary = data.get("summary", "")
    pdf.multi_cell(0, 8, summary)
    pdf.ln(4)

    # 📎 QR Code
    qr_data = "https://navadharma.com"
    qr = qrcode.make(qr_data)
    qr_path = "static/nav_qr.png"
    qr.save(qr_path)
    pdf.image(qr_path, x=160, y=pdf.get_y(), w=30)
    pdf.ln(25)

    # ✅ Save file
    output_path = f"static/{filename}"
    pdf.output(output_path, "F")
    return output_path
