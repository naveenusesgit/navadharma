from fpdf import FPDF
import os
import qrcode
from datetime import datetime

class PDF(FPDF):
    def header(self):
        if os.path.exists("static/logo.png"):
            self.image("static/logo.png", 10, 8, 30)
        self.set_font("Helvetica", "B", 16)
        self.cell(0, 10, "Navadharma Prediction Report", ln=True, align="C")
        self.ln(10)

    def footer(self):
        self.set_y(-20)
        self.set_font("Helvetica", "I", 10)
        self.cell(0, 10, "â€” Nav, Principal Astrologer", ln=True, align="C")
        self.cell(0, 10, "Generated by Navadharma.com", align="C")

def generate_pdf(data: dict, filename="report.pdf"):
    pdf = PDF()
    pdf.add_page()
    pdf.set_auto_page_break(auto=True, margin=15)
    pdf.set_font("Helvetica", "", 12)

    def section_title(title):
        pdf.set_font("Helvetica", "B", 14)
        pdf.set_text_color(40, 40, 100)
        pdf.cell(0, 10, f"ğŸŸ£ {title}", ln=True)
        pdf.set_text_color(0)
        pdf.set_font("Helvetica", "", 12)

    # Birth Info
    section_title("ğŸ§¬ Birth Details")
    pdf.cell(0, 10, f"Name: {data.get('name', 'â€”')}", ln=True)
    pdf.cell(0, 10, f"Date: {data.get('date', 'â€”')}", ln=True)
    pdf.cell(0, 10, f"Time: {data.get('time', 'â€”')}", ln=True)
    pdf.cell(0, 10, f"Place: {data.get('place', 'â€”')}", ln=True)
    pdf.ln(5)

    # Planetary Positions
    section_title("ğŸª Planetary Positions")
    for planet, pos in data.get("planetData", {}).items():
        pdf.cell(0, 10, f"{planet}: {pos}", ln=True)
    pdf.ln(5)

    # Nakshatras
    section_title("ğŸŒŒ Nakshatras")
    for planet, nak in data.get("nakshatras", {}).items():
        pdf.cell(0, 10, f"{planet}: {nak}", ln=True)
    pdf.ln(5)

    # Dasha
    section_title("ğŸ•‰ Current Dasha Period")
    d = data.get("currentDasha", {})
    pdf.cell(0, 10, f"Mahadasha: {d.get('mahadasha')} | Antardasha: {d.get('antardasha')}", ln=True)
    pdf.cell(0, 10, f"Period: {d.get('period')}", ln=True)
    pdf.ln(5)

    # Yogas
    section_title("ğŸ“¿ Yogas & Combinations")
    yogas = data.get("yogas", [])
    if yogas:
        for yoga in yogas:
            pdf.multi_cell(0, 8, f"ğŸ”¹ {yoga}")
    else:
        pdf.cell(0, 10, "No major yogas detected.", ln=True)
    pdf.ln(5)

    # GPT Summary
    section_title("ğŸ’¬ GPT Prediction Summary")
    summary = data.get("gptSummary", "")
    pdf.set_font("Helvetica", "I", 12)
    pdf.multi_cell(0, 8, summary)
    pdf.set_font("Helvetica", "", 12)
    pdf.ln(5)

    # Divisional Charts
    section_title("ğŸ“Š Divisional Charts")
    for chart_type, chart_path in data.get("divisionalCharts", {}).items():
        if os.path.exists(chart_path):
            pdf.cell(0, 10, f"{chart_type} Chart", ln=True)
            pdf.image(chart_path, w=100)
            pdf.ln(5)

    # QR Code
    section_title("ğŸ”— Scan for More")
    qr_data = "https://navadharma.com"
    qr_img = qrcode.make(qr_data)
    qr_path = "static/nav_qr.png"
    qr_img.save(qr_path)
    pdf.image(qr_path, x=160, y=pdf.get_y(), w=30)
    pdf.ln(30)

    # Save PDF
    output_path = f"static/{filename}"
    pdf.output(output_path, "F")
    return output_path
